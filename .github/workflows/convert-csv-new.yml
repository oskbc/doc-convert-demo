name: Convert Markdown to CSV 2

on:
  workflow_dispatch:
    inputs:
      paths:
        description: "変換対象のMarkdownファイルパス（例：docs/src/*.md）"
        required: true
        default: "docs/src/*.md"
      client:
        description: "出力先のサブディレクトリ名（例：default）"
        required: false
        default: "default"

jobs:
  convert-csv:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: Python環境をセットアップ
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3 python3-pip
          pip3 install pandas

      - name: 出力ディレクトリを作成
        run: mkdir -p docs/out

      - name: 入力パラメータを取得
        id: cfg
        run: |
          echo "paths=${{ github.event.inputs.paths }}" >> $GITHUB_OUTPUT
          echo "client=${{ github.event.inputs.client }}" >> $GITHUB_OUTPUT

      - name: Markdown表をCSVに変換
        env:
          INPUT_PATHS: ${{ steps.cfg.outputs.paths }}
          INPUT_CLIENT: ${{ steps.cfg.outputs.client }}
        run: |
          echo "=== 対象ファイル一覧 ==="
          FILES=$(bash -lc "ls -1 ${INPUT_PATHS}")
          echo "$FILES"

          python3 - <<'PY'
import re, pathlib, pandas as pd, os

def md_first_table_to_csv(md_path, out_path):
    lines, in_table = [], False
    with open(md_path, encoding="utf-8") as f:
        for line in f:
            if line.strip().startswith("|"):
                lines.append(line.strip())
                in_table = True
            elif in_table:
                break
    if not lines:
        print(f"⚠️ {md_path} に表が見つかりません。スキップします。")
        return
    rows = [re.split(r"\s*\|\s*", l.strip("|")) for l in lines]
    # 区切り線行を除去（|---|---|---| のような行）
    if len(rows) > 1 and all(set(c) <= {"", "-", ":"} for c in rows[1]):
        rows.pop(1)
    df = pd.DataFrame(rows[1:], columns=rows[0])
    pathlib.Path(out_path).parent.mkdir(parents=True, exist_ok=True)
    df.to_csv(out_path, index=False, encoding="utf-8-sig")
    print(f"✅ {md_path} → {out_path}")

base_dir = "docs/src"
out_root = f"docs/out/{os.environ.get('INPUT_CLIENT', 'default')}"
for md_file in pathlib.Path(base_dir).rglob("*.md"):
    rel = md_file.relative_to(base_dir)
    out_file = pathlib.Path(out_root) / rel.with_suffix(".csv")
    md_first_table_to_csv(md_file, out_file)
PY

      - name: 生成結果をアップロード
        uses: actions/upload-artifact@v4
        with:
          name: csv-outputs
          path: docs/out/**
