name: Convert Markdown to Excel

# --- ワークフロー開始 ---
on:
  workflow_dispatch:
    inputs:
      paths:
        description: "変換したいMarkdownファイル"
        required: true
        default: "docs/src/*.md"
      client:
        description: "テンプレートディレクトリ名（templates/{client}/）"
        required: false
        default: "default"

jobs:
  convert-xlsx:
    runs-on: ubuntu-latest

    steps:
      # --- ① リポジトリをチェックアウト ---
      - uses: actions/checkout@v4

      # --- ② Python環境をセットアップ ---
      - name: Pythonセットアップ
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install pandas openpyxl

      # --- ③ 出力フォルダ作成 ---
      - name: 出力ディレクトリを作成
        run: mkdir -p docs/out

      # --- ④ パラメータ取得 ---
      - name: 入力値を取得
        id: cfg
        run: |
          echo "paths=${{ github.event.inputs.paths }}" >> $GITHUB_OUTPUT
          echo "client=${{ github.event.inputs.client }}" >> $GITHUB_OUTPUT

      # --- ⑤ Markdown → Excel 変換 ---
      - name: MarkdownをExcelに変換
        env:
          INPUT_PATHS: ${{ steps.cfg.outputs.paths }}
          INPUT_CLIENT: ${{ steps.cfg.outputs.client }}
        run: |
          FILES=$(bash -lc "ls -1 ${INPUT_PATHS}")
          echo "=== 対象ファイル ==="
          echo "$FILES"

          for f in $FILES; do
            base=$(basename "$f" .md)
            dir=$(dirname "$f")
            out_dir="docs/out/${INPUT_CLIENT}/${dir#docs/src/}"
            mkdir -p "$out_dir"

            echo "▶ $f → ${out_dir}/${base}.xlsx"

            python3 - <<EOF
import pandas as pd
import re
import pathlib

# Markdown表をExcelに変換する関数
def md_to_xlsx(md_file, out_file):
    lines = []
    in_table = False
    with open(md_file, encoding='utf-8') as f:
        for line in f:
            if re.match(r'^\|', line):
                lines.append(line.strip())
                in_table = True
            elif in_table:
                break  # 最初の表だけを変換
    if not lines:
        print(f"⚠️ No table found in {md_file}")
        return

    rows = [re.split(r'\s*\|\s*', l.strip('|')) for l in lines]
    df = pd.DataFrame(rows[1:], columns=rows[0])
    out_file.parent.mkdir(parents=True, exist_ok=True)
    df.to_excel(out_file, index=False)
    print(f"✅ Converted: {md_file} → {out_file}")

# 実行
md_path = pathlib.Path("${f}")
out_path = pathlib.Path("${out_dir}") / (md_path.stem + ".xlsx")
md_to_xlsx(md_path, out_path)
EOF
          done

      # --- ⑥ 成果物をアップロード ---
      - name: 出力成果物をアップロード
        uses: actions/upload-artifact@v4
        with:
          name: xlsx-outputs
          path: docs/out/**
