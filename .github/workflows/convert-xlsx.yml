name: Convert Markdown to Excel

on:
  workflow_dispatch:
    inputs:
      paths:
        description: "要转换的 Markdown 文件路径（例：docs/src/*.md 或 docs/src/**/*.md）"
        required: true
        default: "docs/src/*.md"
      client:
        description: "输出子目录名（docs/out/{client}/ 下）"
        required: false
        default: "default"

jobs:
  convert-xlsx:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install pandas openpyxl

      - name: Make output dir
        run: mkdir -p docs/out

      - name: Read inputs
        id: cfg
        run: |
          echo "paths=${{ github.event.inputs.paths }}" >> $GITHUB_OUTPUT
          echo "client=${{ github.event.inputs.client }}" >> $GITHUB_OUTPUT

      - name: Create converter script
        run: |
          cat > md_to_xlsx.py <<'PY'
import re, sys, pandas as pd, pathlib

def md_first_table_to_xlsx(md_path, xlsx_path):
    lines, in_table = [], False
    with open(md_path, encoding="utf-8") as f:
        for line in f:
            if line.strip().startswith("|"):
                lines.append(line.strip())
                in_table = True
            elif in_table:
                break
    if not lines:
        print(f"⚠️ No table found in {md_path}")
        return
    rows = [re.split(r"\s*\|\s*", l.strip("|")) for l in lines]
    if set(rows[1]) <= {"", ":", "-", ":--", "--:", "---", ":---:", "--", "---:", ":---"}:
        rows.pop(1)
    df = pd.DataFrame(rows[1:], columns=rows[0])
    p = pathlib.Path(xlsx_path); p.parent.mkdir(parents=True, exist_ok=True)
    df.to_excel(p, index=False)
    print(f"✅ {md_path} -> {xlsx_path}")

if __name__ == "__main__":
    md, out = sys.argv[1], sys.argv[2]
    md_first_table_to_xlsx(md, out)
PY

      - name: Convert Markdown to XLSX
        env:
          INPUT_PATHS: ${{ steps.cfg.outputs.paths }}
          CLIENT: ${{ steps.cfg.outputs.client }}
        shell: bash
        run: |
          set -e
          FILES=$(bash -lc "ls -1 ${INPUT_PATHS}")
          echo "=== Files ==="
          echo "$FILES"
          for f in $FILES; do
            base=$(basename "$f" .md)
            dir=$(dirname "$f")
            out_dir="docs/out/${CLIENT}/${dir#docs/src/}"
            mkdir -p "$out_dir"
            echo "▶ $f → ${out_dir}/${base}.xlsx"
            python3 md_to_xlsx.py "$f" "${out_dir}/${base}.xlsx"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xlsx-outputs
          path: docs/out/**
