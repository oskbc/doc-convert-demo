name: Convert Markdown to PowerPoint (manual)

on:
  workflow_dispatch:
    inputs:
      paths:
        description: "å¤‰æ›ã—ãŸã„Markdownãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹ï¼šdocs/src/demo.md ã¾ãŸã¯ docs/src/**/*.mdï¼‰"
        required: true
        default: "docs/src/**/*.md"
      client:
        description: "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåï¼ˆtemplates/{client}/ï¼‰"
        required: false
        default: "default"

jobs:
  convert-pptx:
    runs-on: ubuntu-latest

    steps:
      # --- â‘  ã‚½ãƒ¼ã‚¹ã‚’å–å¾— ---
      - uses: actions/checkout@v4

      # --- â‘¡ Pandoc ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
      - uses: r-lib/actions/setup-pandoc@v2

      # --- â‘¢ ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---
      - name: æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk librsvg2-bin

      # --- â‘£ å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ ---
      - name: å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        run: mkdir -p docs/out

      # --- â‘¤ å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š ---
      - name: å…¥åŠ›å€¤ã‚’å–å¾—
        id: cfg
        run: |
          echo "paths=${{ github.event.inputs.paths }}" >> $GITHUB_OUTPUT
          echo "client=${{ github.event.inputs.client }}" >> $GITHUB_OUTPUT

      # --- â‘¥ Pandocã§Markdownã‚’PowerPointã«å¤‰æ› ---
      - name: Markdownã‚’PowerPointã«å¤‰æ›
        env:
          INPUT_PATHS: ${{ steps.cfg.outputs.paths }}
          INPUT_CLIENT: ${{ steps.cfg.outputs.client }}
        run: |
          echo "ğŸ” Searching Markdown files in: $INPUT_PATHS"
          FILES=$(bash -lc "ls -1 $INPUT_PATHS 2>/dev/null || true")

          if [ -z "$FILES" ]; then
            echo "âŒ Markdownãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi

          for f in $FILES; do
            base=$(basename "$f" .md)
            dir=$(dirname "$f")
            out_dir="docs/out/${INPUT_CLIENT}/${dir#docs/src/}"
            mkdir -p "$out_dir"

            echo "â–¶ $f â†’ ${out_dir}/${base}.pptx"

            # --- reference.pptx ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ä½¿ç”¨ ---
            if [ -f "templates/${INPUT_CLIENT}/reference.pptx" ]; then
              pandoc "$f" -t pptx -s -o "${out_dir}/${base}.pptx" \
                --resource-path=docs/src \
                --slide-level=2 \
                --reference-doc="templates/${INPUT_CLIENT}/reference.pptx"
            else
              pandoc "$f" -t pptx -s -o "${out_dir}/${base}.pptx" \
                --resource-path=docs/src --slide-level=2
            fi
          done

      # --- â‘¦ æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ---
      - name: æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: pptx-outputs
          path: docs/out/**
