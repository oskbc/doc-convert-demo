name: Convert Markdown to Excel

on:
  workflow_dispatch:
    inputs:
      paths:
        description: "変換したいMarkdownファイル (例: docs/src/*.md)"
        required: true
        default: "docs/src/*.md"
      client:
        description: "テンプレートディレクトリ名（templates/{client}/）"
        required: false
        default: "default"

jobs:
  convert-xlsx:
    runs-on: ubuntu-latest
    steps:
      # --- ① リポジトリをチェックアウト ---
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      # --- ② 必要フォルダ作成 ---
      - name: 必要フォルダを作成
        run: |
          mkdir -p tools
          mkdir -p docs/out

      # --- ③ Python依存ライブラリをインストール ---
      - name: Python依存（openpyxl）をインストール
        run: pip install openpyxl

      # --- ④ Pythonスクリプト生成（テンプレート対応版） ---
      - name: Excel変換スクリプトを生成（テンプレート参照対応）
        run: |
          cat > tools/md_table_to_xlsx.py << 'EOF'
import os, sys, glob, openpyxl

# --- テーブル解析補助関数 ---
def is_table_sep(line):
    line = line.strip()
    if not (line.startswith("|") and line.endswith("|")):
        return False
    core = line.strip("|").replace(" ", "")
    return set(core) <= set("-:|") and "---" in core

def is_table_row(line):
    return line.startswith("|") and line.endswith("|") and line.count("|") >= 2

def parse_table(lines):
    def split_row(s):
        return [c.strip() for c in s.strip()[1:-1].split("|")]
    header = split_row(lines[0])
    rows = [split_row(ln) for ln in lines[2:]]
    return rows, header

def extract_tables(text_lines):
    i, n = 0, len(text_lines)
    while i < n:
        if is_table_row(text_lines[i]):
            if i+1 < n and is_table_sep(text_lines[i+1]):
                j = i+2
                while j < n and is_table_row(text_lines[j]):
                    j += 1
                yield text_lines[i:j]
                i = j
                continue
        i += 1

def main():
    if len(sys.argv) < 4:
        print("usage: <glob_paths> <client> <template_path>")
        sys.exit(1)

    glob_paths, client, template_path = sys.argv[1], sys.argv[2], sys.argv[3]
    files = sorted(glob.glob(glob_paths))

    for f in files:
        with open(f, "r", encoding="utf-8") as fp:
            lines = fp.read().splitlines()

        tables = list(extract_tables(lines))
        if not tables:
            print("SKIP (no tables):", f)
            continue

        rel_dir = os.path.relpath(os.path.dirname(f), "docs/src")
        if rel_dir == ".":
            rel_dir = ""

        base = os.path.splitext(os.path.basename(f))[0]
        out_dir = os.path.join("docs", "out", client, rel_dir)
        os.makedirs(out_dir, exist_ok=True)

        # --- テンプレートがある場合：ロードする ---
        use_template = template_path and os.path.isfile(template_path)

        for idx, tbl in enumerate(tables, start=1):
            rows, header = parse_table(tbl)

            out_path = os.path.join(out_dir, f"{base}_{idx}.xlsx")

            if use_template:
                # --- テンプレート読み込み ---
                wb = openpyxl.load_workbook(template_path)
                ws = wb.active
                print("TEMPLATE USED:", template_path)
            else:
                wb = openpyxl.Workbook()
                ws = wb.active

            # --- 既存内容をクリア（テンプレートのスタイルは残す） ---
            for row in ws["A1:Z300"]:
                for cell in row:
                    cell.value = None

            # --- データ書き込み（A1から） ---
            for c, h in enumerate(header, start=1):
                ws.cell(row=1, column=c, value=h)
            for r_i, r in enumerate(rows, start=2):
                for c_i, v in enumerate(r, start=1):
                    ws.cell(row=r_i, column=c_i, value=v)

            wb.save(out_path)
            print("WRITE:", out_path)

if __name__ == "__main__":
    main()
EOF

      # --- ⑤ Excelテンプレート存在チェック ---
      - name: Excelテンプレート確認
        id: xlsxtmpl
        run: |
          CLIENT=${{ github.event.inputs.client }}
          if [ -f "templates/${CLIENT}/reference.xlsx" ]; then
            echo "template_path=templates/${CLIENT}/reference.xlsx" >> $GITHUB_OUTPUT
            echo "✅ テンプレート使用: templates/${CLIENT}/reference.xlsx"
          elif [ -f "templates/default/reference.xlsx" ]; then
            echo "template_path=templates/default/reference.xlsx" >> $GITHUB_OUTPUT
            echo "⚙️ デフォルトテンプレート使用: templates/default/reference.xlsx"
          else
            echo "template_path=" >> $GITHUB_OUTPUT
            echo "⚠️ Excelテンプレートが見つかりません。空白ワークブックを使用します。"
          fi

      # --- ⑥ 実際の変換処理 ---
      - name: MarkdownからExcelへ変換
        env:
          INPUT_PATHS: ${{ github.event.inputs.paths }}
          CLIENT: ${{ github.event.inputs.client }}
          TEMPLATE_PATH: ${{ steps.xlsxtmpl.outputs.template_path }}
        run: |
          python3 tools/md_table_to_xlsx.py "${INPUT_PATHS}" "${CLIENT}" "${TEMPLATE_PATH}"
          echo "---- 出力完了ファイル ----"
          find docs/out -type f || true

      # --- ⑦ 成果物をアップロード ---
      - name: 成果物（xlsx）をアップロード
        uses: actions/upload-artifact@v4
        with:
          name: xlsx-outputs
          path: docs/out/**
