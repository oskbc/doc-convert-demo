name: Convert Markdown to CSV (Python)

on:
  workflow_dispatch:
    inputs:
      paths:
        description: "変換したいMarkdownファイル（例: docs/src/*.md）"
        required: true
        default: "docs/src/*.md"
      client:
        description: "テンプレートディレクトリ名（templates/{client}/）"
        required: false
        default: "default"

jobs:
  convert-csv:
    runs-on: ubuntu-latest

    steps:
      # --- ① リポジトリをチェックアウト ---
      - uses: actions/checkout@v4

      # --- ② Python セットアップ ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # --- ③ 必要ライブラリをインストール ---
      - name: Install dependencies
        run: |
          pip install pandas markdown

      # --- ④ 出力フォルダを作成 ---
      - name: Create output folder
        run: mkdir -p docs/out

      # --- ⑤ Markdown → CSV 変換（Pythonで実行） ---
      - name: Convert Markdown tables to CSV
        env:
          INPUT_PATHS: ${{ github.event.inputs.paths }}
          INPUT_CLIENT: ${{ github.event.inputs.client }}
        run: |
          echo "=== Markdown → CSV 変換開始 ==="
          python3 - <<EOF
import os, glob, pandas as pd, re

input_paths = "${{ github.event.inputs.paths }}"
client = "${{ github.event.inputs.client }}"
files = glob.glob(input_paths)

if not files:
    print(f"⚠️ Markdownファイルが見つかりません: {input_paths}")
    exit(0)

for f in files:
    print(f"▶ {f}")
    with open(f, encoding="utf-8") as fin:
        text = fin.read()

    # Markdown表を抽出
    tables = re.findall(r'((?:\|.*?\|\n)+)', text)
    if not tables:
        print(f"⚠️ 表が見つかりません: {f}")
        continue

    for i, table_md in enumerate(tables):
        rows = [r.strip('|').split('|') for r in table_md.strip().split('\n')]
        rows = [[c.strip() for c in row] for row in rows]
        df = pd.DataFrame(rows[1:], columns=rows[0])

        base = os.path.basename(f).replace(".md", "")
        out_dir = f"docs/out/{client}"
        os.makedirs(out_dir, exist_ok=True)
        out_file = os.path.join(out_dir, f"{base}_{i+1}.csv")
        df.to_csv(out_file, index=False, encoding="utf-8-sig")
        print(f"✅ 出力: {out_file}")

print("=== 変換完了 ===")
EOF

      # --- ⑥ 成果物をアップロード ---
      - name: Upload generated CSV files
        uses: actions/upload-artifact@v4
        with:
          name: csv-outputs
          path: docs/out/**
