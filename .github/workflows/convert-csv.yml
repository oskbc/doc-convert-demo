name: Convert Markdown to CSV (Python)

on:
  workflow_dispatch:
    inputs:
      paths:
        description: "Markdown files to convert (e.g., docs/src/*.md)"
        required: true
        default: "docs/src/*.md"
      client:
        description: "Client name for output subdir (templates/{client}/)"
        required: false
        default: "default"

jobs:
  convert-csv:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare folders
        run: |
          mkdir -p tools
          mkdir -p docs/out

      - name: Write converter script
        run: |
          cat > tools/md_table_to_csv.py <<EOF
import os
import sys
import csv
import glob

def is_table_sep(line):
    line = line.strip()
    if not (line.startswith("|") and line.endswith("|")):
        return False
    core = line.strip("|").replace(" ", "")
    return set(core) <= set("-:|") and "---" in core

def is_table_row(line):
    line = line.rstrip("\n")
    return line.startswith("|") and line.endswith("|") and line.count("|") >= 2

def parse_table(block_lines):
    def split_row(s):
        return [c.strip() for c in s.strip()[1:-1].split("|")]
    header = split_row(block_lines[0])
    rows = []
    for ln in block_lines[2:]:
        rows.append(split_row(ln))
    return rows, header

def extract_tables(text_lines):
    i = 0
    n = len(text_lines)
    while i < n:
        ln = text_lines[i]
        if is_table_row(ln):
            if i + 1 < n and is_table_sep(text_lines[i + 1]):
                j = i + 2
                while j < n and is_table_row(text_lines[j]):
                    j += 1
                yield text_lines[i:j]
                i = j
                continue
        i += 1

def main():
    if len(sys.argv) < 3:
        print("usage: md_table_to_csv.py <glob_paths> <client>")
        sys.exit(1)
    glob_paths = sys.argv[1]
    client = sys.argv[2]
    files = sorted(glob.glob(glob_paths))
    if not files:
        print("WARNING: no markdown files matched:", glob_paths)
        return
    for f in files:
        with open(f, "r", encoding="utf-8") as fp:
            lines = fp.read().splitlines()
        tables = list(extract_tables(lines))
        if not tables:
            print("SKIP (no tables):", f)
            continue
        try:
            rel_dir = os.path.relpath(os.path.dirname(f), "docs/src")
            if rel_dir == ".":
                rel_dir = ""
        except ValueError:
            rel_dir = ""
        base = os.path.splitext(os.path.basename(f))[0]
        out_dir = os.path.join("docs", "out", client, rel_dir)
        os.makedirs(out_dir, exist_ok=True)
        for idx, tbl in enumerate(tables, start=1):
            rows, header = parse_table(tbl)
            out_path = os.path.join(out_dir, f"{base}_{idx}.csv")
            with open(out_path, "w", encoding="utf-8-sig", newline="") as csvf:
                writer = csv.writer(csvf)
                writer.writerow(header)
                writer.writerows(rows)
            print("WRITE:", out_path)

if __name__ == "__main__":
    main()
EOF

      - name: Convert Markdown tables to CSV
        env:
          INPUT_PATHS: ${{ github.event.inputs.paths }}
          INPUT_CLIENT: ${{ github.event.inputs.client }}
        run: |
          echo "INPUT paths=${INPUT_PATHS}"
          echo "INPUT client=${INPUT_CLIENT}"
          python3 tools/md_table_to_csv.py "${INPUT_PATHS}" "${INPUT_CLIENT}" || true
          echo "OUTPUT listing:"
          (find docs/out -type f -name "*.csv" || true)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: csv-outputs
          path: docs/out/**
