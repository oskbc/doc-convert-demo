name: Convert Markdown to CSV

on:
  workflow_dispatch:
    inputs:
      paths:
        description: "Markdown files to convert (e.g., docs/src/*.md)"
        required: true
        default: "docs/src/*.md"
      client:
        description: "Client name for output subdir (templates/{client}/)"
        required: false
        default: "default"

jobs:
  convert-csv:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare folders
        run: |
          mkdir -p tools
          mkdir -p docs/out

      - name: Write Python converter script safely
        run: |
          echo 'import os, sys, csv, glob' > tools/md_table_to_csv.py
          echo '' >> tools/md_table_to_csv.py
          echo 'def is_table_sep(line):' >> tools/md_table_to_csv.py
          echo '    line = line.strip()' >> tools/md_table_to_csv.py
          echo '    if not (line.startswith("|") and line.endswith("|")):' >> tools/md_table_to_csv.py
          echo '        return False' >> tools/md_table_to_csv.py
          echo '    core = line.strip("|").replace(" ", "")' >> tools/md_table_to_csv.py
          echo '    return set(core) <= set("-:|") and "---" in core' >> tools/md_table_to_csv.py
          echo '' >> tools/md_table_to_csv.py
          echo 'def is_table_row(line):' >> tools/md_table_to_csv.py
          echo '    line = line.rstrip("\\n")' >> tools/md_table_to_csv.py
          echo '    return line.startswith("|") and line.endswith("|") and line.count("|") >= 2' >> tools/md_table_to_csv.py
          echo '' >> tools/md_table_to_csv.py
          echo 'def parse_table(block_lines):' >> tools/md_table_to_csv.py
          echo '    def split_row(s):' >> tools/md_table_to_csv.py
          echo '        return [c.strip() for c in s.strip()[1:-1].split("|")]' >> tools/md_table_to_csv.py
          echo '    header = split_row(block_lines[0])' >> tools/md_table_to_csv.py
          echo '    rows = []' >> tools/md_table_to_csv.py
          echo '    for ln in block_lines[2:]:' >> tools/md_table_to_csv.py
          echo '        rows.append(split_row(ln))' >> tools/md_table_to_csv.py
          echo '    return rows, header' >> tools/md_table_to_csv.py
          echo '' >> tools/md_table_to_csv.py
          echo 'def extract_tables(text_lines):' >> tools/md_table_to_csv.py
          echo '    i = 0' >> tools/md_table_to_csv.py
          echo '    n = len(text_lines)' >> tools/md_table_to_csv.py
          echo '    while i < n:' >> tools/md_table_to_csv.py
          echo '        ln = text_lines[i]' >> tools/md_table_to_csv.py
          echo '        if is_table_row(ln):' >> tools/md_table_to_csv.py
          echo '            if i + 1 < n and is_table_sep(text_lines[i + 1]):' >> tools/md_table_to_csv.py
          echo '                j = i + 2' >> tools/md_table_to_csv.py
          echo '                while j < n and is_table_row(text_lines[j]):' >> tools/md_table_to_csv.py
          echo '                    j += 1' >> tools/md_table_to_csv.py
          echo '                yield text_lines[i:j]' >> tools/md_table_to_csv.py
          echo '                i = j' >> tools/md_table_to_csv.py
          echo '                continue' >> tools/md_table_to_csv.py
          echo '        i += 1' >> tools/md_table_to_csv.py
          echo '' >> tools/md_table_to_csv.py
          echo 'def main():' >> tools/md_table_to_csv.py
          echo '    if len(sys.argv) < 3:' >> tools/md_table_to_csv.py
          echo '        print("usage: md_table_to_csv.py <glob_paths> <client>")' >> tools/md_table_to_csv.py
          echo '        sys.exit(1)' >> tools/md_table_to_csv.py
          echo '    glob_paths = sys.argv[1]' >> tools/md_table_to_csv.py
          echo '    client = sys.argv[2]' >> tools/md_table_to_csv.py
          echo '    files = sorted(glob.glob(glob_paths))' >> tools/md_table_to_csv.py
          echo '    if not files:' >> tools/md_table_to_csv.py
          echo '        print("No markdown files found:", glob_paths)' >> tools/md_table_to_csv.py
          echo '        return' >> tools/md_table_to_csv.py
          echo '    for f in files:' >> tools/md_table_to_csv.py
          echo '        with open(f, "r", encoding="utf-8") as fp:' >> tools/md_table_to_csv.py
          echo '            lines = fp.read().splitlines()' >> tools/md_table_to_csv.py
          echo '        tables = list(extract_tables(lines))' >> tools/md_table_to_csv.py
          echo '        if not tables:' >> tools/md_table_to_csv.py
          echo '            print("SKIP (no tables):", f)' >> tools/md_table_to_csv.py
          echo '            continue' >> tools/md_table_to_csv.py
          echo '        try:' >> tools/md_table_to_csv.py
          echo '            rel_dir = os.path.relpath(os.path.dirname(f), "docs/src")' >> tools/md_table_to_csv.py
          echo '            if rel_dir == ".":' >> tools/md_table_to_csv.py
          echo '                rel_dir = ""' >> tools/md_table_to_csv.py
          echo '        except ValueError:' >> tools/md_table_to_csv.py
          echo '            rel_dir = ""' >> tools/md_table_to_csv.py
          echo '        base = os.path.splitext(os.path.basename(f))[0]' >> tools/md_table_to_csv.py
          echo '        out_dir = os.path.join("docs", "out", client, rel_dir)' >> tools/md_table_to_csv.py
          echo '        os.makedirs(out_dir, exist_ok=True)' >> tools/md_table_to_csv.py
          echo '        for idx, tbl in enumerate(tables, start=1):' >> tools/md_table_to_csv.py
          echo '            rows, header = parse_table(tbl)' >> tools/md_table_to_csv.py
          echo '            out_path = os.path.join(out_dir, f"{base}_{idx}.csv")' >> tools/md_table_to_csv.py
          echo '            with open(out_path, "w", encoding="utf-8-sig", newline="") as csvf:' >> tools/md_table_to_csv.py
          echo '                writer = csv.writer(csvf)' >> tools/md_table_to_csv.py
          echo '                writer.writerow(header)' >> tools/md_table_to_csv.py
          echo '                writer.writerows(rows)' >> tools/md_table_to_csv.py
          echo '            print("WRITE:", out_path)' >> tools/md_table_to_csv.py
          echo '' >> tools/md_table_to_csv.py
          echo 'if __name__ == "__main__":' >> tools/md_table_to_csv.py
          echo '    main()' >> tools/md_table_to_csv.py

      - name: Run converter
        env:
          INPUT_PATHS: ${{ github.event.inputs.paths }}
          INPUT_CLIENT: ${{ github.event.inputs.client }}
        run: |
          python3 tools/md_table_to_csv.py "${INPUT_PATHS}" "${INPUT_CLIENT}"
          echo "---- Output files ----"
          (find docs/out -type f || true)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: csv-outputs
          path: docs/out/**
